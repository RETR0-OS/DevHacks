{% extends "base.html" %}

{% block content %}
<!-- Finetuning Settings Section -->
<div class="container mx-auto px-4 py-8 max-w-4xl">
    <!-- Header -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-white">Finetuning Settings</h1>
        <p class="text-gray-400 mt-2">Configure your model training parameters</p>
    </div>

    <!-- Main Settings Form -->
    <form id="finetuning-form" class="space-y-8">
        <!-- Section 1: Configuration Summary -->
        <div class="bg-gray-800 rounded-lg p-6">
            <h2 class="text-xl font-semibold text-white mb-4">Configuration Summary</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-400 mb-1">Task</label>
                    <div class="bg-gray-900 border border-gray-700 rounded-lg p-3 text-white">{{ default_values.task }}</div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-400 mb-1">Model Name</label>
                    <div class="bg-gray-900 border border-gray-700 rounded-lg p-3 text-white">{{ default_values.model_name }}</div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-400 mb-1">Compute Tier</label>
                    <div class="bg-gray-900 border border-gray-700 rounded-lg p-3 text-white">{{ default_values.compute_specs }}</div>
                </div>
            </div>
        </div>

        <!-- Section 2: Basic Settings -->
        <div class="bg-gray-800 rounded-lg p-6">
            <h2 class="text-xl font-semibold text-white mb-4">Basic Settings</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="num_train_epochs" class="block text-sm font-medium text-gray-400 mb-1">Number of Training Epochs</label>
                    <input type="number" id="num_train_epochs" name="num_train_epochs" min="1" max="100"
                           value="{{ default_values.num_train_epochs }}"
                           class="bg-gray-900 border border-gray-700 rounded-lg p-3 w-full text-white focus:border-orange-500 focus:outline-none">
                </div>
                <div>
                    <label for="lora_r" class="block text-sm font-medium text-gray-400 mb-1">LoRA R</label>
                    <select id="lora_r" name="lora_r"
                            class="bg-gray-900 border border-gray-700 rounded-lg p-3 w-full text-white focus:border-orange-500 focus:outline-none">
                        <option value="8" {% if default_values.lora_r == 8 %}selected{% endif %}>8</option>
                        <option value="16" {% if default_values.lora_r == 16 %}selected{% endif %}>16</option>
                        <option value="32" {% if default_values.lora_r == 32 %}selected{% endif %}>32</option>
                        <option value="64" {% if default_values.lora_r == 64 %}selected{% endif %}>64</option>
                    </select>
                </div>
                <div>
                    <label for="max_seq_length" class="block text-sm font-medium text-gray-400 mb-1">Max Sequence Length</label>
                    <input type="number" id="max_seq_length" name="max_seq_length"
                           value="{{ default_values.max_seq_length if default_values.max_seq_length else -1 }}"
                           class="bg-gray-900 border border-gray-700 rounded-lg p-3 w-full text-white focus:border-orange-500 focus:outline-none">
                </div>
                <div>
                    <label for="dataset_file" class="block text-sm font-medium text-gray-400 mb-1">Dataset File</label>
                    <div class="flex items-center">
                        <label class="w-full flex items-center justify-center px-4 py-2 border border-gray-700 rounded-lg cursor-pointer bg-gray-900 hover:bg-gray-800 transition">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                            </svg>
                            <span class="text-white">Upload Dataset</span>
                            <input type="file" id="dataset_file" name="dataset_file" accept=".json,.csv,.jsonl" class="hidden">
                        </label>
                    </div>
                    <p id="file-name" class="mt-2 text-sm text-gray-400"></p>
                </div>
            </div>
        </div>
        <!-- Advanced Settings Toggle -->
        <div class="flex justify-center mb-6">
            <button id="toggle-advanced" type="button" class="flex items-center text-orange-500 hover:text-orange-400 transition">
                <span class="mr-2">Advanced Settings</span>
                <svg id="advanced-icon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 transform transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
            </button>
        </div>

        <!-- Advanced Settings Toggle -->
        <div id="advanced-settings" class="hidden space-y-6">
            <!-- LoRA Settings -->
            <div class="border-t border-gray-700 pt-4">
                <h3 class="text-lg font-medium text-white mb-3">LoRA Settings</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="lora_alpha" class="block text-sm font-medium text-gray-400 mb-1">LoRA Alpha</label>
                        <input type="number" id="lora_alpha" name="lora_alpha"
                               value="{{ default_values.lora_alpha }}"
                               class="bg-gray-900 border border-gray-700 rounded-lg p-3 w-full text-white focus:border-orange-500 focus:outline-none">
                    </div>
                    <div>
                        <label for="lora_dropout" class="block text-sm font-medium text-gray-400 mb-1">LoRA Dropout</label>
                        <input type="number" id="lora_dropout" name="lora_dropout" step="0.01" min="0" max="1"
                               value="{{ default_values.lora_dropout }}"
                               class="bg-gray-900 border border-gray-700 rounded-lg p-3 w-full text-white focus:border-orange-500 focus:outline-none">
                    </div>
                </div>
            </div>

            <!-- BitsAndBytes Settings -->
            <div class="border-t border-gray-700 pt-4">
                <h3 class="text-lg font-medium text-white mb-3">BitsAndBytes Settings</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="load_in_4bit" class="flex items-center">
                            <input type="radio" id="load_in_4bit" name="quantization" value="4bit"
                                   {% if default_values.use_4bit %}checked{% endif %}
                                   class="rounded-full bg-gray-900 border-gray-700 text-orange-500 focus:ring-orange-500">
                            <span class="ml-2 text-sm text-gray-400">Load in 4-bit</span>
                        </label>
                    </div>
                    <div>
                        <label for="load_in_8bit" class="flex items-center">
                            <input type="radio" id="load_in_8bit" name="quantization" value="8bit"
                                   {% if default_values.load_in_8bit %}checked{% endif %}
                                   class="rounded-full bg-gray-900 border-gray-700 text-orange-500 focus:ring-orange-500">
                            <span class="ml-2 text-sm text-gray-400">Load in 8-bit</span>
                        </label>
                    </div>
                    <div>
                        <label for="no_quantization" class="flex items-center">
                            <input type="radio" id="no_quantization" name="quantization" value="none"
                                   {% if not default_values.use_4bit and not default_values.load_in_8bit %}checked{% endif %}
                                   class="rounded-full bg-gray-900 border-gray-700 text-orange-500 focus:ring-orange-500">
                            <span class="ml-2 text-sm text-gray-400">No quantization</span>
                        </label>
                    </div>
                    <div>
                        <label for="bnb_4bit_compute_dtype" class="block text-sm font-medium text-gray-400 mb-1">BnB 4-bit Compute Dtype</label>
                        <select id="bnb_4bit_compute_dtype" name="bnb_4bit_compute_dtype"
                                class="bg-gray-900 border border-gray-700 rounded-lg p-3 w-full text-white focus:border-orange-500 focus:outline-none">
                            <option value="nf4" {% if default_values.bnb_4bit_compute_dtype == "nf4" %}selected{% endif %}>NF4</option>
                            <option value="fp16" {% if default_values.bnb_4bit_compute_dtype == "fp16" %}selected{% endif %}>FP16</option>
                            <option value="bf16" {% if default_values.bnb_4bit_compute_dtype == "bf16" %}selected{% endif %}>BF16</option>
                        </select>
                    </div>
                    <div>
                        <label class="flex items-center">
                            <input type="checkbox" id="bnb_4bit_use_quant_type" name="bnb_4bit_use_quant_type"
                                   {% if default_values.bnb_4bit_use_quant_type %}checked{% endif %}
                                   class="rounded bg-gray-900 border-gray-700 text-orange-500 focus:ring-orange-500">
                            <span class="ml-2 text-sm text-gray-400">Use 4-bit Quant Type</span>
                        </label>
                    </div>
                    <div>
                        <label class="flex items-center">
                            <input type="checkbox" id="use_nested_quant" name="use_nested_quant"
                                   {% if default_values.use_nested_quant %}checked{% endif %}
                                   class="rounded bg-gray-900 border-gray-700 text-orange-500 focus:ring-orange-500">
                            <span class="ml-2 text-sm text-gray-400">Use Nested Quantization</span>
                        </label>
                    </div>
                    <div>
                        <label for="bnb_4bit_quant_type" class="block text-sm font-medium text-gray-400 mb-1">BnB 4-bit Quant Type</label>
                        <select id="bnb_4bit_quant_type" name="bnb_4bit_quant_type"
                                class="bg-gray-900 border border-gray-700 rounded-lg p-3 w-full text-white focus:border-orange-500 focus:outline-none">
                            <option value="nf4" {% if default_values.bnb_4bit_quant_type == "nf4" %}selected{% endif %}>NF4</option>
                            <option value="fp4" {% if default_values.bnb_4bit_quant_type == "fp4" %}selected{% endif %}>FP4</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Precision Settings -->
            <div class="border-t border-gray-700 pt-4">
                <h3 class="text-lg font-medium text-white mb-3">Precision Settings</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="flex items-center">
                            <input type="checkbox" id="fp16" name="fp16"
                                   {% if default_values.fp16 %}checked{% endif %}
                                   class="rounded bg-gray-900 border-gray-700 text-orange-500 focus:ring-orange-500">
                            <span class="ml-2 text-sm text-gray-400">Use FP16</span>
                        </label>
                    </div>
                    <div>
                        <label class="flex items-center">
                            <input type="checkbox" id="bf16" name="bf16"
                                   {% if default_values.bf16 %}checked{% endif %}
                                   class="rounded bg-gray-900 border-gray-700 text-orange-500 focus:ring-orange-500">
                            <span class="ml-2 text-sm text-gray-400">Use BF16</span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Training Parameters -->
            <div class="border-t border-gray-700 pt-4">
                <h3 class="text-lg font-medium text-white mb-3">Training Parameters</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="per_device_train_batch_size" class="block text-sm font-medium text-gray-400 mb-1">Train Batch Size</label>
                        <input type="number" id="per_device_train_batch_size" name="per_device_train_batch_size" min="1"
                               value="{{ default_values.per_device_train_batch_size }}"
                               class="bg-gray-900 border border-gray-700 rounded-lg p-3 w-full text-white focus:border-orange-500 focus:outline-none">
                    </div>
                    <div>
                        <label for="per_device_eval_batch_size" class="block text-sm font-medium text-gray-400 mb-1">Eval Batch Size</label>
                        <input type="number" id="per_device_eval_batch_size" name="per_device_eval_batch_size" min="1"
                               value="{{ default_values.per_device_eval_batch_size }}"
                               class="bg-gray-900 border border-gray-700 rounded-lg p-3 w-full text-white focus:border-orange-500 focus:outline-none">
                    </div>
                    <div>
                        <label for="learning_rate" class="block text-sm font-medium text-gray-400 mb-1">Learning Rate</label>
                        <input type="number" id="learning_rate" name="learning_rate" step="0.0001"
                               value="{{ default_values.learning_rate }}"
                               class="bg-gray-900 border border-gray-700 rounded-lg p-3 w-full text-white focus:border-orange-500 focus:outline-none">
                    </div>
                    <div>
                        <label for="gradient_accumulation_steps" class="block text-sm font-medium text-gray-400 mb-1">Gradient Accumulation Steps</label>
                        <input type="number" id="gradient_accumulation_steps" name="gradient_accumulation_steps" min="1"
                               value="{{ default_values.gradient_accumulation_steps }}"
                               class="bg-gray-900 border border-gray-700 rounded-lg p-3 w-full text-white focus:border-orange-500 focus:outline-none">
                    </div>
                    <div>
                        <label for="max_grad_norm" class="block text-sm font-medium text-gray-400 mb-1">Max Gradient Norm</label>
                        <input type="number" id="max_grad_norm" name="max_grad_norm" step="0.1"
                               value="{{ default_values.max_grad_norm }}"
                               class="bg-gray-900 border border-gray-700 rounded-lg p-3 w-full text-white focus:border-orange-500 focus:outline-none">
                    </div>
                    <div>
                        <label for="warmup_ratio" class="block text-sm font-medium text-gray-400 mb-1">Warmup Ratio</label>
                        <input type="number" id="warmup_ratio" name="warmup_ratio" min="0" step="0.01"
                               value="{{ default_values.warmup_ratio }}"
                               class="bg-gray-900 border border-gray-700 rounded-lg p-3 w-full text-white focus:border-orange-500 focus:outline-none">
                    </div>
                    <div>
                        <label for="weight_decay" class="block text-sm font-medium text-gray-400 mb-1">Weight Decay</label>
                        <input type="number" id="weight_decay" name="weight_decay" step="0.001" min="0"
                               value="{{ default_values.weight_decay }}"
                               class="bg-gray-900 border border-gray-700 rounded-lg p-3 w-full text-white focus:border-orange-500 focus:outline-none">
                    </div>
                    <div>
                        <label class="flex items-center">
                            <input type="checkbox" id="gradient_checkpointing" name="gradient_checkpointing"
                                   {% if default_values.gradient_checkpointing %}checked{% endif %}
                                   class="rounded bg-gray-900 border-gray-700 text-orange-500 focus:ring-orange-500">
                            <span class="ml-2 text-sm text-gray-400">Gradient Checkpointing</span>
                        </label>
                    </div>
                    <div>
                        <label class="flex items-center">
                            <input type="checkbox" id="group_by_length" name="group_by_length"
                                   {% if default_values.group_by_length %}checked{% endif %}
                                   class="rounded bg-gray-900 border-gray-700 text-orange-500 focus:ring-orange-500">
                            <span class="ml-2 text-sm text-gray-400">Group by Length</span>
                        </label>
                    </div>
                    <div>
                        <label class="flex items-center">
                            <input type="checkbox" id="packing" name="packing"
                                   {% if default_values.packing %}checked{% endif %}
                                   class="rounded bg-gray-900 border-gray-700 text-orange-500 focus:ring-orange-500">
                            <span class="ml-2 text-sm text-gray-400">Use Packing</span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Optimizer & Scheduler Settings -->
            <div class="border-t border-gray-700 pt-4">
                <h3 class="text-lg font-medium text-white mb-3">Optimizer & Scheduler</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="optim" class="block text-sm font-medium text-gray-400 mb-1">Optimizer</label>
                        <select id="optim" name="optim"
                                class="bg-gray-900 border border-gray-700 rounded-lg p-3 w-full text-white focus:border-orange-500 focus:outline-none">
                            <option value="paged_adamw_32bit" {% if default_values.optim == "paged_adamw_32bit" %}selected{% endif %}>Paged AdamW 32-bit</option>
                            <option value="paged_adamw_8bit" {% if default_values.optim == "paged_adamw_8bit" %}selected{% endif %}>Paged AdamW 8-bit</option>
                            <option value="adamw_torch" {% if default_values.optim == "adamw_torch" %}selected{% endif %}>AdamW Torch</option>
                            <option value="adamw_hf" {% if default_values.optim == "adamw_hf" %}selected{% endif %}>AdamW HF</option>
                        </select>
                    </div>
                    <div>
                        <label for="lr_scheduler_type" class="block text-sm font-medium text-gray-400 mb-1">LR Scheduler Type</label>
                        <select id="lr_scheduler_type" name="lr_scheduler_type"
                                class="bg-gray-900 border border-gray-700 rounded-lg p-3 w-full text-white focus:border-orange-500 focus:outline-none">
                            <option value="cosine" {% if default_values.lr_scheduler_type == "cosine" %}selected{% endif %}>Cosine</option>
                            <option value="linear" {% if default_values.lr_scheduler_type == "linear" %}selected{% endif %}>Linear</option>
                            <option value="constant" {% if default_values.lr_scheduler_type == "constant" %}selected{% endif %}>Constant</option>
                            <option value="constant_with_warmup" {% if default_values.lr_scheduler_type == "constant_with_warmup" %}selected{% endif %}>Constant with Warmup</option>
                        </select>
                    </div>
                    <div>
                        <label for="max_steps" class="block text-sm font-medium text-gray-400 mb-1">Max Steps (-1 for auto)</label>
                        <input type="number" id="max_steps" name="max_steps"
                               value="{{ default_values.max_steps }}"
                               class="bg-gray-900 border border-gray-700 rounded-lg p-3 w-full text-white focus:border-orange-500 focus:outline-none">
                    </div>
                </div>
            </div>
        </div>

        <!-- Start Finetuning Button -->
        <div class="text-center">
            <button type="submit" class="bg-orange-500 hover:bg-orange-600 px-6 py-3 rounded-lg font-medium transition inline-flex items-center">
                Start Finetuning
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                </svg>
            </button>
        </div>
    </form>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Toggle advanced settings
        const toggleAdvanced = document.getElementById('toggle-advanced');
        const advancedSettings = document.getElementById('advanced-settings');
        const advancedIcon = document.getElementById('advanced-icon');

        toggleAdvanced.addEventListener('click', function() {
            advancedSettings.classList.toggle('hidden');
            advancedIcon.classList.toggle('rotate-180');
        });

        // Display file name when selected
        const datasetFile = document.getElementById('dataset_file');
        const fileName = document.getElementById('file-name');

        datasetFile.addEventListener('change', function() {
            if (this.files.length > 0) {
                fileName.textContent = this.files[0].name;
            } else {
                fileName.textContent = '';
            }
        });

        // Form submission
        const form = document.getElementById('finetuning-form');
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            // Form submission logic will go here
            console.log('Form submitted - implementation pending');
        });
    });
</script>
{% endblock %}